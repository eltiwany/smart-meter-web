<app-top-bar
  [exportOptions]="false"
  [newButton]="false"
></app-top-bar>

<div class="card mb-4 shadow">
  <div class="card-header bg-primary text-white">
    <h5 class="p-0 m-0 font-weight-750" style="float:left">
      <i class="bi bi-file-text-fill" style="margin-right: 10px;"></i>
      Smart meter customers in maps
    </h5>
    <!-- Message Button -->
    <button class="btn btn-warning" style="float: right" (click)="modal.open(modalMessage, 'xl')">
      <i class="icon icon-xs me-2 bi bi-tag-fill"></i>
      Get Reports by Specific Area
    </button>
  </div>
  <div class="card-body" *ngIf="isConnected">
    <google-map width="100%" [options]="mapOptions" *ngIf="spots.length > 0">
      <map-marker
        *ngFor="let spot of spots"
        [position]="{ lat: spot.lat, lng: spot.lng }"
        [options]="{
          icon: {
            url: '/assets/images/location.png',
            labelOrigin: labelPosition
          },
          label: {
            text: spot.label,
            fontWeight: 'bold',
            fontSize: '15px',
            color: 'red'
          }
        }"
        [clickable]="true"
        (mapClick)="selectMarker(spot, modalMap)"
      ></map-marker>
    </google-map>
  </div>
  <div class="card-body bg-danger text-white" *ngIf="!isConnected">
    Please enable internet connection to preview maps.
  </div>
</div>

<!-- Map Details Modal -->
<ng-template #modalMap let-modald let-c="close" let-d="dismiss" class="p-0">
  <div class="modal-header bg-warning">
      <h2 class="h6 modal-title">Customer Details</h2>
      <div class="btn-right">
        <button type="button" class="btn btn-link border-0 text-white" (click)="modald.dismiss('Cross click')">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
  </div>
  <div class="modal-body">
    <table class="table table-hover table-bordered" *ngIf="spot">
      <tr>
        <th>Customer Name</th>
        <td>{{ spot.label }}</td>
      </tr>
      <tr>
        <th>Meter Token</th>
        <td>{{ spot.token }}</td>
      </tr>
      <tr>
        <th>Power</th>
        <td>{{ general.formatNumber(spot.powerdata.power, 1) }}W</td>
      </tr>
      <tr>
        <th>Power Losses</th>
        <td>{{ general.formatNumber(spot.powerdata.powerlosses, 1) }}W</td>
      </tr>
      <tr>
        <th>Energy</th>
        <td>{{ general.formatNumber(spot.powerdata.energy, 1) }}Wh</td>
      </tr>
      <tr>
        <th>Earthing fault current</th>
        <td>{{ general.formatNumber(spot.powerdata.losses, 1) }}A</td>
      </tr>
      <tr>
        <th>Ground Resitance</th>
        <td>{{ general.formatNumber(spot.powerdata.losses_resistance, 1) }}Ω</td>
      </tr>
    </table>
  </div>
</ng-template>

  <!-- Clear Logs Modal with Dynamic Form Loading -->
<ng-template #modalMessage let-modald let-c="close" let-d="dismiss" class="p-0">
  <div class="modal-header bg-warning">
      <h2 class="h6 modal-title">Get Reports by Specific Area</h2>
      <div class="btn-right">
        <button *ngIf="summaryByArea.length > 0" class="btn btn-success" (click)="printDiv('printContent')">
          <i class="bi bi-printer-fill"></i> Print
        </button>
        <button type="button" class="btn btn-link border-0 text-white" (click)="modald.dismiss('Cross click')">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
  </div>
  <div class="modal-body" *ngIf="cities">
    <form class="p-1" [formGroup]="form" autocomplete="off">
      <div class="row">
        <div class="col col-md-4">
          <div class="form-floating mb-3">
            <select
              formControlName="city"
              type="text"
              class="form-control"
              id="floatingChartSelector"
              placeholder="City"
              (change)="filterRegions()"
            >
              <option *ngFor="let city of cities" [value]="city"> {{ city }} </option>
            </select>
            <label for="floatingChartSelector">City</label>
          </div>
        </div>

        <div class="col col-md-4">
          <div class="form-floating mb-3">
            <select
              formControlName="region"
              type="text"
              class="form-control"
              id="floatingChartSelector"
              placeholder="Region"
              (change)="filterDistricts()"
            >
              <option *ngFor="let region of regions" [value]="region.name"> {{ region.name }} </option>
            </select>
            <label for="floatingChartSelector">Region</label>
          </div>
        </div>

        <div class="col col-md-4">
          <div class="form-floating mb-3">
            <select
              formControlName="district"
              type="text"
              class="form-control"
              id="floatingChartSelector"
              placeholder="District"
            >
              <option *ngFor="let district of districts" [value]="district"> {{ district }} </option>
            </select>
            <label for="floatingChartSelector">District</label>
          </div>
        </div>

        <div class="col col-md-5">
          <div class="form-floating mb-3">
            <input
              formControlName="startDate"
              type="date"
              class="form-control"
              id="floatingChartSelector"
              placeholder="Start Date"
            />
            <label for="floatingChartSelector">Start Date</label>
          </div>
        </div>

        <div class="col col-md-5">
          <div class="form-floating mb-3">
            <input
              formControlName="endDate"
              type="date"
              class="form-control"
              id="floatingChartSelector"
              placeholder="End Date"
            />
            <label for="floatingChartSelector">End Date</label>
          </div>
        </div>

        <div class="col col-md-2">
          <div class="form-floating mb-3">
            <button class="btn btn-primary w-100" style="height: 55px" (click)="getSummaryByArea()">
              <i class="bi bi-search"></i> Search
            </button>
          </div>
        </div>

      </div>

      <div id="printContent">
        <div class="row" *ngIf="startDate?.valid && endDate?.valid && summaryByArea.length > 0">
          <h3 class="text-center mt-2">Smart Meter(s) Report By Area</h3>
          <h5 class="text-center mb-2">{{ startDate?.value | date:'fullDate' }} - {{ endDate?.value | date:'fullDate' }}</h5>
          <p><b>City: </b> {{ city?.value }}</p>
          <p><b>Region: </b> {{ region?.value }}</p>
          <p><b>District: </b> {{ district?.value }}</p>

          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <tr>
                <th>S/N</th>
                <th>Time</th>
                <th>Voltage (V)</th>
                <th>Current (A)</th>
                <th>Power (kW)</th>
                <th>Loss (kW)</th>
                <th>Earthing fault current (A)</th>
                <th>Earthing resistance (Ω)</th>
              </tr>

              <tr *ngFor="let summary of summaryByArea, let i = index">
                <td>{{ i + 1 }}</td>
                <td>{{ summary.time }}</td>
                <td>{{ summary.voltage  | number:'1.4-4'}}</td>
                <td>{{ summary.current  | number:'1.4-4'}}</td>
                <td>{{ summary.power  | number:'1.4-4'}}</td>
                <td>{{ summary.loss  | number:'1.4-4'}}</td>
                <td>{{ summary.earthing | number:'1.4-4' }}</td>
                <td>{{ summary.earthing_resistance | number:'1.4-4' }}</td>
              </tr>

              <tr>
                <th colspan="2">Total</th>
                <th>{{ sumValue(summaryByArea, 'power') | number:'1.4-4' }}</th>
                <th>{{ sumValue(summaryByArea, 'loss') | number:'1.4-4' }}</th>
                <th>{{ sumValue(summaryByArea, 'earthing') | number:'1.4-4' }}</th>
                <th>{{ sumValue(summaryByArea, 'earthing_resistance') | number:'1.4-4' }}</th>
              </tr>
            </table>
          </div>

        </div>
        <div class="alert alert-warning" *ngIf="startDate?.valid && endDate?.valid && summaryByArea.length == 0">No data found.</div>
      </div>
    </form>
  </div>
</ng-template>

<div class="card mb-4 shadow">
  <div class="card-header bg-primary text-white">
    <h5 class="p-0 m-0 font-weight-750" style="float:left">
      <i class="bi bi-file-text-fill" style="margin-right: 10px;"></i>
      Checkout the report for customers smart home in the past 12 hours*
    </h5>
  </div>
  <div class="card-body">
    <div class="row">
      <!-- Cards with counting summary -->
      <app-card-md4
        *ngFor="let datum of data"
        class="col-md-4"
        [cardName]="datum[0].name"
        [cardNumber]="getPower(datum[0].value)"
        [cardNumberSI]="datum[0]?.si"
        [iconName]="datum[1].iconName"
        [bgColor]="datum[1].bgColor"
        [textColor]="datum[1].textColor"
        [allDataUrl]="datum[1].allDataUrl"
      ></app-card-md4>
    </div>
  </div>
</div>

<div class="card mb-4 shadow">
  <div class="card-header bg-primary text-white">
    <h5 class="p-0 m-0 font-weight-750">
      <i class="bi bi-table" style="margin-right: 10px;"></i>
      View detailed losses for all smart meters past 12 hours
    </h5>
  </div>
  <div class="card-body" *ngIf="powerWithLosses.length > 0">
    <div class="row">
      <app-chart-selector
        [rootColumns]="powerWithLosses"
        [rootSensor]="sensors"
      ></app-chart-selector>
    </div>
  </div>
</div>
