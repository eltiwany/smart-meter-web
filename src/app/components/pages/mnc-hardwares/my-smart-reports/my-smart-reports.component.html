<app-top-bar
  [exportOptions]="false"
  [newButton]="false"
></app-top-bar>

<div class="card mb-4 shadow">
  <div class="card-header bg-primary text-white">
    <h5 class="p-0 m-0 font-weight-750">
      <i class="bi bi-heart-fill" style="margin-right: 10px;"></i>
      Checkout status summary of your smart home
    </h5>
  </div>
  <div class="card-body">
      <div class="row" *ngIf="currentData.length > 0">
        <div [class]="'col-md-6 my-2'" style="font-weight: bold; text-decoration: underline; cursor: pointer;">
          <div (click)="scrollToReport()" [class]="'bg-' + getNoticationPowerStatus().status + ' rounded p-3 ' + (getNoticationPowerStatus().status == 'warning' ? '' : 'text-white')">
            <i class="bi bi-{{ getNoticationPowerStatus().status == 'success' ? 'check' : 'exclamation' }}-circle"></i>
            &emsp; {{ getNoticationPowerStatus().message }}
          </div>
        </div>

        <div [class]="'col-md-6 my-2'" style="font-weight: bold;">
          <div [class]="'bg-' + getNoticationStatus(currentData[0].statuses, currentData[0]?.sensor?.threshold, currentData[0]?.sensor?.threshold_percentage, currentData[0].si).status + ' rounded p-3 ' + (getNoticationStatus(currentData[0].statuses, currentData[0]?.sensor?.threshold, currentData[0]?.sensor?.threshold_percentage, currentData[0].si).status == 'warning' ? '' : 'text-white')">
            <i class="bi bi-{{ getNoticationStatus(currentData[0].statuses, currentData[0]?.sensor?.threshold, currentData[0]?.sensor?.threshold_percentage, currentData[0].si).status == 'success' ? 'check' : 'exclamation' }}-circle"></i>
            &emsp; {{ getNoticationStatus(currentData[0].statuses, currentData[0]?.sensor?.threshold, currentData[0]?.sensor?.threshold_percentage, currentData[0].si).status == 'success' ? 'Earthing fault current is normal' : 'Check status of Earthing fault current' }}
          </div>
        </div>

        <div [class]="'col-md-6 my-2'" style="font-weight: bold;">
          <div [class]="'bg-' + getNoticationStatus(resistanceData[0].statuses, resistanceData[0]?.sensor?.threshold, resistanceData[0]?.sensor?.threshold_percentage, resistanceData[0].si).status + ' rounded p-3 ' + (getNoticationStatus(resistanceData[0].statuses, resistanceData[0]?.sensor?.threshold, resistanceData[0]?.sensor?.threshold_percentage, resistanceData[0].si).status == 'warning' ? '' : 'text-white')">
            <i class="bi bi-{{ getNoticationStatus(resistanceData[0].statuses, resistanceData[0]?.sensor?.threshold, resistanceData[0]?.sensor?.threshold_percentage, resistanceData[0].si).status == 'success' ? 'check' : 'exclamation' }}-circle"></i>
            &emsp; {{ getNoticationStatus(resistanceData[0].statuses, resistanceData[0]?.sensor?.threshold, resistanceData[0]?.sensor?.threshold_percentage, resistanceData[0].si).status == 'success' ? 'Earthing resistance is normal' : 'Check status of Earthing resistance' }}
          </div>
        </div>

        <div [class]="'col-md-6 my-2'" style="font-weight: bold;">
          <div [class]="'bg-' + (availableUnits > 10 ? 'success' : 'warning') + ' rounded p-3 ' + (availableUnits <= 10 ? '' : 'text-white')">
            <i class="bi bi-{{ availableUnits > 10 ? 'check' : 'exclamation' }}-circle"></i>
            &emsp; {{ availableUnits > 10 ? 'Units are available' : 'Available units are not sufficient' }}
          </div>
        </div>

      </div>
  </div>
</div>

<div class="card mb-4 shadow">
  <div class="card-header bg-primary text-white">
    <h5 class="p-0 m-0 font-weight-750" style="float:left">
      <i class="bi bi-file-text-fill" style="margin-right: 10px;"></i>
      {{ fullName }}'s smart home in the past 12 hours<br/>
    </h5>
    <!-- Message Button -->
    <button class="btn btn-warning" style="float: right" (click)="modal.open(modalMessage, 'xl')">
      <i class="icon icon-xs me-2 bi bi-printer-fill"></i>
      Get Smart Appliances(s) Usage Report
    </button>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col col-md-8">
        <div class="row">
          <div
            *ngFor="let datum of data; index as i"
            class="col-12">
              <app-card-brief
                *ngIf="i == 0"
                class="col-md-3"
                [addedHeight]="(data.length / 2)"
                [cardName]="datum[0].name"
                [cardNumber]="getPower(datum[0].value)"
                [cardNumberSI]="datum[0]?.si"
                [allDataUrl]="null"
              ></app-card-brief>
          </div>
        </div>
      </div>

      <div class="col col-md-4">
        <div class="row">
          <div
          *ngFor="let datum of data; index as i"
          class="col-12">
            <app-card-brief
              *ngIf="i != 0"
              class="col-md-3"
              [cardName]="datum[0].name"
              [cardNumber]="getPower(datum[0].value)"
              [cardNumberSI]="datum[0]?.si"
              [allDataUrl]="datum[0]?.name == 'Smart Appliances' ? '/hardwares/smart-appliances' : null"
              ></app-card-brief>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Clear Logs Modal with Dynamic Form Loading -->
<ng-template #modalMessage let-modald let-c="close" let-d="dismiss" class="p-0">
  <div class="modal-header bg-warning">
    <h2 class="h6 modal-title">Smart Appliances(s) Usage Report</h2>
    <div class="btn-right">
      <button *ngIf="summaryByArea.length > 0" class="btn btn-success" (click)="printDiv('printContent')">
        <i class="bi bi-printer-fill"></i> Print
      </button>
      <button type="button" class="btn btn-link border-0 text-white" (click)="modald.dismiss('Cross click')">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
  </div>
  <div class="modal-body" *ngIf="startDate && endDate">
    <form class="p-1" [formGroup]="form" autocomplete="off">
      <div class="row">
        <div class="col col-md-6">
          <div class="form-floating mb-3">
            <input
              formControlName="startDate"
              type="date"
              class="form-control"
              id="floatingChartSelector"
              placeholder="Start Date"
              (change)="getSummaryByArea()"
            />
            <label for="floatingChartSelector">Start Date</label>
          </div>
        </div>

        <div class="col col-md-6">
          <div class="form-floating mb-3">
            <input
              formControlName="endDate"
              type="date"
              class="form-control"
              id="floatingChartSelector"
              placeholder="End Date"
              (change)="getSummaryByArea()"
            />
            <label for="floatingChartSelector">End Date</label>
          </div>
        </div>

      </div>

      <div id="printContent">
        <div class="row" *ngIf="startDate?.valid && endDate?.valid && summaryByArea.length > 0">
          <h3 class="text-center mt-2">Smart Appliances(s) Usage Report</h3>
          <h5 class="text-center mb-2">{{ startDate?.value | date:'fullDate' }} - {{ endDate?.value | date:'fullDate' }}</h5>

          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <tr>
                <th>S/N</th>
                <th>Time</th>
                <th>Power (kW)</th>
                <th>Loss (kW)</th>
                <th>Earthing fault current (A)</th>
                <th>Ground Resitance (Î©)</th>
              </tr>

              <tr *ngFor="let summary of summaryByArea, let i = index">
                <td>{{ i + 1 }}</td>
                <td>{{ summary.time }}</td>
                <td>{{ summary.power | number:'1.4-4' }}</td>
                <td>{{ summary.loss | number:'1.4-4' }}</td>
                <td>{{ summary.earthing | number:'1.4-4' }}</td>
                <td>{{ summary.earthing_resistance | number:'1.4-4' }}</td>
              </tr>

              <tr>
                <th colspan="2">Total</th>
                <th>{{ sumValue(summaryByArea, 'power')  | number:'1.4-4' }}</th>
                <th>{{ sumValue(summaryByArea, 'loss')  | number:'1.4-4' }}</th>
                <th>{{ sumValue(summaryByArea, 'earthing')  | number:'1.4-4' }}</th>
                <th>{{ sumValue(summaryByArea, 'earthing_resistance')  | number:'1.4-4' }}</th>
              </tr>
            </table>
          </div>

        </div>
        <div class="alert alert-warning" *ngIf="startDate?.valid && endDate?.valid && summaryByArea.length == 0">No data found.</div>
      </div>
    </form>
  </div>
</ng-template>

<div class="card mb-4 shadow">
  <div class="card-header bg-primary text-white">
    <h5 class="p-0 m-0 font-weight-750">
      <i class="bi bi-table" style="margin-right: 10px;"></i>
      View data of your appliances in past 12 hours
    </h5>
  </div>
  <div class="card-body">
    <div class="row">
      <app-chart-selector-by-device
        [sensorsList]="sensors"
      ></app-chart-selector-by-device>
    </div>
  </div>
</div>

<div class="card mb-4 shadow" id="smartApplianceReports">
  <div class="card-header bg-primary text-white">
    <h5 class="p-0 m-0 font-weight-750">
      <i class="bi bi-heart-fill" style="margin-right: 10px;"></i>
      Checkout the detailed status of your smart appliances
    </h5>
  </div>
  <div class="card-body">
      <div class="table-responsive">
        <table class="table table-flush dataTable-table" id="htmlData">
          <thead class="thead-light">
          <tr class="text-center">
            <th rowspan="1">ID</th>
            <th rowspan="1">Appliance Name</th>
            <th colspan="5">Power Usage</th>
            <th rowspan="1">Status</th>
          </tr>
          <tr class="text-center">
            <th></th>
            <th></th>
            <th>Last Year</th>
            <th>Last Month</th>
            <th>Last 2 weeks</th>
            <th>Last Week</th>
            <th>Last 24hrs</th>
            <th></th>
          </tr>
          </thead>
          <tbody *ngIf="healthStatus?.length != 0">
          <ng-container *ngFor="let datum of  healthStatus; let i = index">
            <tr [class]="datum?.sensor?.id ? '' : 'bg-danger text-white'">
              <td>{{ datum?.sensor?.id ?? '##' }}</td>
              <th>{{ datum?.sensor?.user_defined_name ?? 'Device not detected' }}</th>
              <td class="text-center" *ngFor="let status of datum.statuses">{{ general.formatNumber(status, 2) }}{{ datum.si }}</td>
              <td [class]="getNoticationStatus(datum.statuses, datum?.sensor?.threshold, datum?.sensor?.threshold_percentage, datum.si).status == 'warning' ? 'bg-' + getNoticationStatus(datum.statuses, datum?.sensor?.threshold, datum?.sensor?.threshold_percentage, datum.si).status + ' font-weight-750' : 'bg-' + getNoticationStatus(datum.statuses, datum?.sensor?.threshold, datum?.sensor?.threshold_percentage, datum.si).status + ' text-white font-weight-750'">
                {{ getNoticationStatus(datum.statuses, datum?.sensor?.threshold, datum?.sensor?.threshold_percentage, datum.si).message }}
              </td>
            </tr>
          </ng-container>
          <tbody *ngIf="healthStatus?.length == 0">
            <tr>
              <th colspan="3">No data found.</th>
            </tr>
          </tbody>
        </table>
      </div>
  </div>
</div>
